<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Territorial Multiplayer</title>
    <style>
        body { margin:0; font-family:Arial; background:#222; color:white; }

        #lobbyContainer {
            position:absolute; top:0; left:0; right:0; bottom:0;
            display:flex; justify-content:center; align-items:center;
            background:rgba(0,0,0,0.7); backdrop-filter:blur(6px);
            flex-direction:column;
        }

        .card {
            background:#333; padding:20px; width:300px;
            border-radius:10px; box-shadow:0 0 15px #000;
        }

        input, button {
            width:100%; padding:10px; margin-top:10px;
            border:none; border-radius:6px; font-size:16px;
        }
        button { background:#4caf50; color:white; cursor:pointer; }
        button:hover { background:#45a049; }
        .danger { background:#b32a2a !important; }
        .dark { background:#555 !important; }
    </style>
</head>
<body>

<div id="lobbyContainer">
    <div class="card" id="mainLobby">
        <h2 style="text-align:center;">Multiplayer Lobby</h2>

        <input id="playerName" placeholder="Your Name">
        <button onclick="createRoom()">Create Room</button>

        <input id="joinRoomId" placeholder="Room ID">
        <button class="dark" onclick="joinRoom()">Join Room</button>
    </div>

    <div class="card" id="roomScreen" style="display:none;">
        <h3 id="roomTitle">Room: ---</h3>
        <div id="playersList" style="margin-top:10px; font-size:15px;"></div>

        <button onclick="startGame()" id="startBtn" style="display:none; margin-top:20px;">Start Game</button>
        <button class="danger" onclick="leaveRoom()">Leave Room</button>
    </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } 
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

import { getDatabase, ref, set, push, onValue, remove, update }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDKBOpclh-zb8pACwUvLyTTzXwyRhHijKo",
    authDomain: "terrtioral.firebaseapp.com",
    databaseURL: "https://terrtioral-default-rtdb.firebaseio.com",
    projectId: "terrtioral",
    storageBucket: "terrtioral.firebasestorage.app",
    messagingSenderId: "45249886132",
    appId: "1:45249886132:web:24ee3e122db9809d3464e1",
    measurementId: "G-G7NQ9LMTL5"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// STATE
let currentRoom = "";
let myId = Math.random().toString(36).substring(2, 8);

// UI
const lobbyUI = document.getElementById("mainLobby");
const roomUI  = document.getElementById("roomScreen");
const playersList = document.getElementById("playersList");
const startBtn = document.getElementById("startBtn");

// FUNCTIONS
function createRoom(){
    let name = playerName.value.trim();
    if(!name) return alert("Enter your name!");

    let roomId = Math.random().toString(36).substring(2, 7);
    currentRoom = roomId;

    set(ref(db, "rooms/" + roomId), {
        host: myId,
        players: {
            [myId]: name
        },
        started: false
    });

    lobbyUI.style.display="none";
    roomUI.style.display="block";
    document.getElementById("roomTitle").innerText = "Room: " + roomId;

    listenRoom(roomId);
}

function joinRoom(){
    let name = playerName.value.trim();
    let roomId = joinRoomId.value.trim();
    if(!roomId || !name) return alert("Fill all fields");

    currentRoom = roomId;

    update(ref(db, "rooms/" + roomId + "/players/" + myId), name);

    lobbyUI.style.display="none";
    roomUI.style.display="block";
    document.getElementById("roomTitle").innerText = "Room: " + roomId;

    listenRoom(roomId);
}

function listenRoom(roomId){
    onValue(ref(db, "rooms/" + roomId), snap=>{
        let data = snap.val();
        if(!data){ alert("Room closed"); location.reload(); return; }

        playersList.innerHTML = "";
        let count = 0;

        for(let pid in data.players){
            playersList.innerHTML += "â€¢ " + data.players[pid] + "<br>";
            count++;
        }

        if(data.host === myId){
            startBtn.style.display = (count >= 2) ? "block" : "none";
        } else {
            startBtn.style.display = "none";
        }

        if(data.started === true){
            startActualGame(data);
        }
    });
}

function leaveRoom(){
    remove(ref(db, "rooms/" + currentRoom + "/players/" + myId));
    remove(ref(db, "rooms/" + currentRoom));
    location.reload();
}

function startGame(){
    update(ref(db, "rooms/" + currentRoom), { started:true });
}

function startActualGame(roomData){
    document.getElementById("lobbyContainer").style.display="none";
    alert("Game Started!");
}

</script>

</body>
</html>
