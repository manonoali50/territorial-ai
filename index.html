<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Territorial Online</title>
<style>
body { margin:0; overflow:hidden; background:#111; color:#fff; font-family:Tahoma,Arial,sans-serif; }

/* زر الرجوع */
#backBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  background:#222;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #555;
  font-size:15px;
  z-index:1000;
}

/* زر فتح الكونسل */
#consoleBtn {
  position: fixed;
  top: 10px;
  left: 10px;
  background:#333;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #666;
  z-index:1000;
}

#consoleBox {
  position: fixed;
  top: 50px;
  left: 10px;
  width: calc(100% - 20px);
  max-width:1000px;
  height: 40%;
  background:rgba(0,0,0,0.92);
  color:#0f0;
  padding:10px;
  overflow-y:auto;
  display:none;
  border:2px solid #0f0;
  z-index:2000;
  box-sizing:border-box;
}

#closeConsole {
  position: absolute;
  top: 6px;
  right: 12px;
  color:red;
  font-weight:bold;
  cursor:pointer;
  font-size:18px;
}

canvas { display:block; width:100%; height:100vh; background:#fff; }
#logArea{ white-space:pre-wrap; font-family:monospace; font-size:14px; }
</style>
</head>
<body>

<button id="backBtn" title="Back to lobby" onclick="goBack()">Back</button>
<button id="consoleBtn" title="Open Console" onclick="toggleConsole()">Console</button>

<div id="consoleBox" aria-hidden="true">
  <span id="closeConsole" onclick="toggleConsole()">X</span>
  <div id="logArea"></div>
</div>

<canvas id="game"></canvas>

<script>
/* ---------- Console UI helpers ---------- */
function log(msg){
  const el = document.getElementById("logArea");
  const t = typeof msg === 'string' ? msg : JSON.stringify(msg);
  el.innerText += t + "\n";
  el.parentElement.scrollTop = el.parentElement.scrollHeight;
}
function toggleConsole(){
  const box = document.getElementById("consoleBox");
  if(box.style.display === "block"){
    box.style.display = "none";
    box.setAttribute('aria-hidden','true');
  } else {
    box.style.display = "block";
    box.setAttribute('aria-hidden','false');
  }
}
function goBack(){
  // أفضل سلوك: ارجع للتاريخ السابق (لوبي)
  if(window.history.length>1) history.back(); else location.reload();
}

/* ---------- Canvas & WebSocket ---------- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

let players = {}; // map color -> {x,y}
let myColor = '#ffffff';

/* Build a resilient WebSocket URL:
   - try same-origin first
   - if it fails, fallback to known server (Railway host)
*/
const FALLBACK_WS_HOST = 'territorial-ai-production.up.railway.app'; // <-- لو غيرت السيرفر غيّر هنا
function makeWsUrl(hostToTry){
  const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
  return `${proto}://${hostToTry}`;
}

function connectWebSocket(){
  let triedFallback = false;
  let ws = null;

  function tryConnect(host){
    const url = makeWsUrl(host);
    log("Attempt WS -> " + url);
    ws = new WebSocket(url);

    ws.addEventListener('open', ()=>{
      log("Connected to " + host);
      ws.send(JSON.stringify({ type:'join', room:'Room' }));
    });

    ws.addEventListener('message', (ev)=>{
      try {
        const data = JSON.parse(ev.data);
        // messages: joined, count, update, full
        if(data.type === 'joined'){
          myColor = data.color || myColor;
          log("Joined: color=" + myColor);
        } else if(data.type === 'count'){
          log("Players in room: " + data.players);
        } else if(data.type === 'update'){
          // data.color, x, y
          if(data.color){
            players[data.color] = { x: data.x, y: data.y };
          }
        } else if(data.type === 'full'){
          log("Room is full");
        }
      } catch(e){
        log("msg parse error: " + e.message);
      }
    });

    ws.addEventListener('error', (e)=>{
      log("WebSocket error: " + (e && e.message ? e.message : String(e)));
    });

    ws.addEventListener('close', (ev)=>{
      log("Disconnected.");
      // if closed before we had a successful connect, try fallback once
      if(!triedFallback && host !== FALLBACK_WS_HOST){
        triedFallback = true;
        log("Trying fallback host: " + FALLBACK_WS_HOST);
        setTimeout(()=> tryConnect(FALLBACK_WS_HOST), 400);
      }
    });

    // mouse movement -> send update
    window.onmousemove = (e)=>{
      if(ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({ type:'update', x: e.clientX, y: e.clientY }));
      }
    };
  }

  // first try same-origin host (location.host)
  tryConnect(location.host);
}

connectWebSocket();

/* ---------- render loop ---------- */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const color in players){
    const p = players[color];
    if(!p) continue;
    ctx.fillStyle = color || '#000';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 14, 0, Math.PI*2);
    ctx.fill();
    // draw border
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#222';
    ctx.stroke();
  }
  requestAnimationFrame(render);
}
render();
</script>
</body>
</html>
